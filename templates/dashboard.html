<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIRA效率分析系统</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 效率分析区域样式 */
        .efficiency-analysis-section {
            margin: 40px 0;
        }
        
        .efficiency-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .efficiency-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .analysis-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .analysis-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .formula-container .formula {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .effectiveness-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .analysis-metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .analysis-metric .label {
            font-weight: bold;
            color: #333;
        }
        
        .analysis-metric .value {
            color: #667eea;
            font-weight: bold;
        }
        
        /* JIRA连接区域样式 */
        .jira-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 40px;
        }
        
        .jira-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .jira-header h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .jira-connection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .connection-form, .project-selector {
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .efficiency-header h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 JIRA效率分析系统</h1>
            <p>AI智能分单 vs 人工分单效率对比分析</p>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">{{ metrics.total_tickets }}</div>
                <div class="metric-label">总工单数</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.ai_tickets }}</div>
                <div class="metric-label">AI分单</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.manual_tickets }}</div>
                <div class="metric-label">人工分单</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.completion_rate }}%</div>
                <div class="metric-label">完成率</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.avg_ai_processing_time }}</div>
                <div class="metric-label">AI平均处理时间(分钟)</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.avg_manual_processing_time }}</div>
                <div class="metric-label">人工平均处理时间(分钟)</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.efficiency_improvement }}%</div>
                <div class="metric-label">效率提升</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.time_saved_total_hours }}</div>
                <div class="metric-label">节省总时间(小时)</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.ai_speed_ratio }}x</div>
                <div class="metric-label">AI处理速度倍数</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value">{{ metrics.cost_efficiency_percent }}%</div>
                <div class="metric-label">成本效益提升</div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-container">
                <div id="comparisonChart"></div>
            </div>
            
            <div class="chart-container">
                <div id="workloadChart"></div>
            </div>
        </div>
        
        <!-- 效率对比分析区域 -->
        <div class="efficiency-analysis-section">
            <div class="efficiency-header">
                <h2>🚀 AI智能分单效果验证</h2>
                <p>数据驱动的系统有效性证明</p>
            </div>
            
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>⏱️ 时间效率分析</h3>
                    <div id="timeAnalysis"></div>
                </div>
                
                <div class="analysis-card">
                    <h3>📈 生产力提升指标</h3>
                    <div id="productivityMetrics"></div>
                </div>
                
                <div class="analysis-card">
                    <h3>💰 投资回报率(ROI)</h3>
                    <div id="roiCalculation"></div>
                </div>
                
                <div class="analysis-card">
                    <h3>🎯 核心效益公式</h3>
                    <div class="formula-container">
                        <p><strong>效率提升公式:</strong></p>
                        <div class="formula">效率提升% = (人工平均时间 - AI平均时间) / 人工平均时间 × 100%</div>
                        
                        <p><strong>时间节省公式:</strong></p>
                        <div class="formula">总节省时间 = AI处理工单数 × (人工平均时间 - AI平均时间)</div>
                        
                        <p><strong>生产力倍数:</strong></p>
                        <div class="formula">生产力倍数 = 人工平均时间 / AI平均时间</div>
                        
                        <div class="effectiveness-summary" id="effectivenessSummary"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- JIRA连接区域 -->
        <div class="jira-section">
            <div class="jira-header">
                <h2>🔗 JIRA系统直连</h2>
                <p>直接从JIRA系统获取项目数据并进行智能分析</p>
            </div>
            
            <div class="jira-connection" id="jiraConnection">
                <div class="connection-form">
                    <h3>连接配置</h3>
                    <div class="form-group">
                        <label>JIRA服务器地址:</label>
                        <input type="url" id="jiraServer" placeholder="https://your-domain.atlassian.net" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>用户名/邮箱:</label>
                        <input type="text" id="jiraUsername" placeholder="your-email@company.com" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>API Token:</label>
                        <input type="password" id="jiraToken" placeholder="Your JIRA API Token" class="form-input">
                        <small>在JIRA设置中生成API Token</small>
                    </div>
                    <button class="btn" onclick="connectJira()">🔗 连接JIRA</button>
                </div>
                
                <div class="project-selector" id="projectSelector" style="display: none;">
                    <h3>选择项目</h3>
                    <select id="projectSelect" class="form-input">
                        <option value="">请选择项目...</option>
                    </select>
                    <button class="btn" onclick="importJiraData()">📊 导入项目数据</button>
                    <button class="btn" onclick="analyzeJiraData()">🔍 高级分析</button>
                </div>
            </div>
            
            <div id="jiraStatus" class="status-message"></div>
        </div>

        <div class="upload-section">
            <h2>📁 手动数据上传</h2>
            <div class="upload-area" id="uploadArea">
                <p>拖拽文件到此处或点击选择文件</p>
                <p style="color: #666; margin-top: 10px;">支持 CSV, Excel, JSON 格式</p>
                <input type="file" id="fileInput" style="display: none;" accept=".csv,.xlsx,.json">
            </div>
            
            <button class="btn" onclick="document.getElementById('fileInput').click()">选择文件</button>
            <button class="btn" onclick="exportReport()">导出Excel报告</button>
            <button class="btn" onclick="refreshData()">刷新数据</button>
            
            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h3>📋 数据模板下载</h3>
                <p style="color: #666; margin: 10px 0;">如果您是首次使用，建议下载模板文件，按照格式填入您的数据</p>
                <button class="btn" onclick="downloadTemplate('csv')">📄 下载CSV模板</button>
                <button class="btn" onclick="downloadTemplate('excel')">📊 下载Excel模板</button>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>
    
    <script>
        // 加载图表
        function loadCharts() {
            // 加载对比图表
            fetch('/api/charts/comparison')
                .then(response => response.json())
                .then(data => {
                    Plotly.newPlot('comparisonChart', JSON.parse(data));
                })
                .catch(error => console.error('Error loading comparison chart:', error));
            
            // 加载工作负载图表
            fetch('/api/charts/workload')
                .then(response => response.json())
                .then(data => {
                    Plotly.newPlot('workloadChart', JSON.parse(data));
                })
                .catch(error => console.error('Error loading workload chart:', error));
        }
        
        // 文件上传处理
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const statusMessage = document.getElementById('statusMessage');
        
        fileInput.addEventListener('change', handleFileUpload);
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(102, 126, 234, 0.2)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileUpload();
            }
        });
        
        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            showStatus('正在上传文件...', 'info');
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showStatus(data.error, 'error');
                }
            })
            .catch(error => {
                showStatus('上传失败: ' + error.message, 'error');
            });
        }
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }
        
        function exportReport() {
            window.location.href = '/api/export/excel';
        }
        
        function refreshData() {
            location.reload();
        }
        
        function downloadTemplate(type) {
            const url = type === 'csv' ? '/api/template/csv' : '/api/template/excel';
            const link = document.createElement('a');
            link.href = url;
            link.download = type === 'csv' ? 'jira_data_template.csv' : 'jira_data_template.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`正在下载${type.toUpperCase()}模板文件...`, 'success');
        }
        
        // JIRA连接功能
        function connectJira() {
            const server = document.getElementById('jiraServer').value.trim();
            const username = document.getElementById('jiraUsername').value.trim();
            const token = document.getElementById('jiraToken').value.trim();
            
            if (!server || !username || !token) {
                showJiraStatus('请填写完整的连接信息', 'error');
                return;
            }
            
            showJiraStatus('正在连接JIRA服务器...', 'info');
            
            fetch('/api/jira/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    server: server,
                    username: username,
                    token: token
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showJiraStatus(`连接成功！服务器: ${data.server}`, 'success');
                    loadJiraProjects();
                } else {
                    showJiraStatus(data.error, 'error');
                }
            })
            .catch(error => {
                showJiraStatus('连接失败: ' + error.message, 'error');
            });
        }
        
        function loadJiraProjects() {
            fetch('/api/jira/projects')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('projectSelect');
                        select.innerHTML = '<option value="">请选择项目...</option>';
                        
                        data.projects.forEach(([key, name]) => {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${key} - ${name}`;
                            select.appendChild(option);
                        });
                        
                        document.getElementById('projectSelector').style.display = 'block';
                        showJiraStatus(`发现 ${data.count} 个项目`, 'success');
                    } else {
                        showJiraStatus(data.error, 'error');
                    }
                })
                .catch(error => {
                    showJiraStatus('获取项目列表失败: ' + error.message, 'error');
                });
        }
        
        function importJiraData() {
            const projectKey = document.getElementById('projectSelect').value;
            if (!projectKey) {
                showJiraStatus('请先选择一个项目', 'error');
                return;
            }
            
            showJiraStatus('正在导入项目数据，请稍候...', 'info');
            
            fetch(`/api/jira/import/${projectKey}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showJiraStatus(`${data.message}`, 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        showJiraStatus(data.error, 'error');
                    }
                })
                .catch(error => {
                    showJiraStatus('导入数据失败: ' + error.message, 'error');
                });
        }
        
        function analyzeJiraData() {
            showJiraStatus('正在进行高级分析...', 'info');
            
            fetch('/api/jira/analysis/advanced')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showJiraStatus(data.error, 'error');
                        return;
                    }
                    
                    // 显示分析结果
                    displayAdvancedAnalysis(data);
                    showJiraStatus('高级分析完成！', 'success');
                })
                .catch(error => {
                    showJiraStatus('分析失败: ' + error.message, 'error');
                });
        }
        
        function displayAdvancedAnalysis(analysis) {
            // 创建分析结果显示窗口
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;
                display: flex; align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 15px; padding: 30px; 
                max-width: 90%; max-height: 90%; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #667eea;">🔍 JIRA项目高级分析报告</h2>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        background: #f44336; color: white; border: none; 
                        padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: auto;
                    ">关闭</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <h3>📊 项目健康度</h3>
                        <p><strong>健康评分:</strong> ${analysis.project_health?.health_score || 0}/100</p>
                        <p><strong>状态:</strong> ${analysis.project_health?.health_status || '未知'}</p>
                        <p><strong>解决率:</strong> ${analysis.project_health?.resolution_rate || 0}%</p>
                        <p><strong>平均解决时间:</strong> ${analysis.project_health?.avg_resolution_days || 0} 天</p>
                    </div>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <h3>👥 团队绩效</h3>
                        <p><strong>团队规模:</strong> ${analysis.team_performance?.team_size || 0} 人</p>
                        <p><strong>最佳表现:</strong> ${analysis.team_performance?.top_performer || '未知'}</p>
                        <p><strong>最高产出:</strong> ${analysis.team_performance?.most_productive || '未知'}</p>
                    </div>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <h3>⚡ 质量指标</h3>
                        <p><strong>质量评分:</strong> ${analysis.quality_metrics?.quality_score || 0}/100</p>
                        <p><strong>高优先级比例:</strong> ${analysis.quality_metrics?.high_priority_rate || 0}%</p>
                        <p><strong>未分配比例:</strong> ${analysis.quality_metrics?.unassigned_rate || 0}%</p>
                        <p><strong>超期比例:</strong> ${analysis.quality_metrics?.overdue_rate || 0}%</p>
                    </div>
                    
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <h3>📈 资源利用</h3>
                        <p><strong>资源利用率:</strong> ${analysis.resource_allocation?.resource_utilization || 0}%</p>
                        <p><strong>负载平衡度:</strong> ${analysis.resource_allocation?.workload_balance_score || 0}/100</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>💡 关键洞察和建议</h3>
                    ${analysis.insights_and_recommendations?.map(insight => `
                        <div style="background: ${insight.level === 'alert' ? '#ffebee' : '#fff3e0'}; 
                                    padding: 10px; border-radius: 5px; margin: 10px 0; 
                                    border-left: 4px solid ${insight.level === 'alert' ? '#f44336' : '#ff9800'};">
                            <strong>${insight.message}</strong><br>
                            <small>建议: ${insight.recommendation}</small>
                        </div>
                    `).join('') || '<p>暂无特殊洞察</p>'}
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function showJiraStatus(message, type) {
            const statusElement = document.getElementById('jiraStatus');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }
        
        // 加载效率分析数据
        function loadEfficiencyAnalysis() {
            fetch('/api/efficiency/analysis')
                .then(response => response.json())
                .then(data => {
                    // 填充时间效率分析
                    const timeAnalysis = document.getElementById('timeAnalysis');
                    timeAnalysis.innerHTML = `
                        <div class="analysis-metric">
                            <span class="label">AI平均处理时间:</span>
                            <span class="value">${data.time_analysis.ai_avg_time} 分钟</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">人工平均处理时间:</span>
                            <span class="value">${data.time_analysis.manual_avg_time} 分钟</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">每张工单节省时间:</span>
                            <span class="value">${data.time_analysis.time_saved_per_ticket} 分钟</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">总计节省时间:</span>
                            <span class="value">${data.time_analysis.total_time_saved_hours} 小时</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">AI处理速度优势:</span>
                            <span class="value">${data.time_analysis.ai_speed_advantage}</span>
                        </div>
                    `;
                    
                    // 填充生产力指标
                    const productivityMetrics = document.getElementById('productivityMetrics');
                    productivityMetrics.innerHTML = `
                        <div class="analysis-metric">
                            <span class="label">生产力提升倍数:</span>
                            <span class="value">${data.productivity_metrics.productivity_gain_ratio}x</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">成本效益提升:</span>
                            <span class="value">${data.productivity_metrics.cost_efficiency}%</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">工单完成率:</span>
                            <span class="value">${data.productivity_metrics.completion_rate}%</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">AI vs 人工比例:</span>
                            <span class="value">${data.summary.ai_vs_manual_ratio}</span>
                        </div>
                    `;
                    
                    // 填充ROI计算
                    const roiCalculation = document.getElementById('roiCalculation');
                    roiCalculation.innerHTML = `
                        <div class="analysis-metric">
                            <span class="label">效率评分:</span>
                            <span class="value">${data.roi_calculation.efficiency_score}/100</span>
                        </div>
                        <div class="analysis-metric">
                            <span class="label">预估月节省成本:</span>
                            <span class="value">¥${data.roi_calculation.estimated_monthly_savings}</span>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                            <strong>计算说明:</strong> ${data.roi_calculation.description}
                        </p>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 10px;">
                            <strong>公式:</strong> ${data.roi_calculation.formula}
                        </p>
                    `;
                    
                    // 填充有效性总结
                    const effectivenessSummary = document.getElementById('effectivenessSummary');
                    const improvement = data.summary.overall_efficiency_improvement;
                    let conclusion = '';
                    if (improvement > 50) {
                        conclusion = '🎉 系统表现卓越！AI分单显著提升工作效率';
                    } else if (improvement > 20) {
                        conclusion = '👍 系统表现良好！AI分单明显优于人工分单';
                    } else if (improvement > 0) {
                        conclusion = '✅ 系统有效！AI分单略优于人工分单';
                    } else {
                        conclusion = '⚠️ 需要优化！建议检查AI分单策略';
                    }
                    
                    effectivenessSummary.innerHTML = `
                        <h4>📊 系统有效性验证结果</h4>
                        <p><strong>整体效率提升:</strong> ${improvement}%</p>
                        <p><strong>结论:</strong> ${conclusion}</p>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                            基于 ${data.summary.total_tickets} 张工单的数据分析，AI智能分单系统相比传统人工分单在处理效率上有显著提升。
                        </p>
                    `;
                })
                .catch(error => console.error('Error loading efficiency analysis:', error));
        }
        
        // 页面加载时初始化图表和分析数据
        document.addEventListener('DOMContentLoaded', function() {
            loadCharts();
            loadEfficiencyAnalysis();
        });
    </script>
</body>
</html>